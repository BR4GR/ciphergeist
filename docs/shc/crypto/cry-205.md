# cry

## Description
Holy smokes Timothy! You locked the Code for the printer in the vault again.
What did I tell you about using the vault without your supervisor? It's your job to retreive the printer code again
How am I supposed to print Barbaras time table?

## Author
TheBadGod

## Solution

```python
#!/usr/bin/env python3

from os import getenv
from secrets import randbelow
from string import printable

from Crypto.Cipher import AES
from Crypto.Util.number import long_to_bytes
from Crypto.Util.Padding import pad, unpad


def encrypt(data, keys):
    if isinstance(data, str):
        data = data.encode()

    data = pad(data, 16)

    data += b"<<valid_secret>>"

    for k in keys:
        data = AES.new(k, AES.MODE_ECB).encrypt(data)

    return data


def decrypt(data, keys):
    if isinstance(data, str):
        data = data.encode()

    for k in keys[::-1]:
        data = AES.new(k, AES.MODE_ECB).decrypt(data)

    if data[-16:] != b"<<valid_secret>>":
        return f"Could not decrypt; invalid data: {data[:-16]}"

    return f"Decrypted data: {unpad(data[:-16], 16)}"


def add(vault, keys, key, data):
    vault[key] = encrypt(data, keys)


def get(vault, keys, key):
    return decrypt(vault.get(key, b""), keys)


def generate_keys():
    return [long_to_bytes(randbelow(2**9)).ljust(16) for _ in range(6)]


def main():
    vault = {}

    print("Welcome to the future of secret vaults")
    print("Here you can store all your secrets")

    admin_keys = generate_keys()
    user_keys = generate_keys()
    add(vault, admin_keys, "example", "nobody will be able to read this")
    add(vault, admin_keys, "FLAG", getenv("FLAG", "flag{fakeflagfakeflag}"))

    EVALUATION_PERIOD = 5

    while 1:
        print(f"Vault menu: {EVALUATION_PERIOD} TESTING QUERIES LEFT")
        print("  1) add value to vault")
        print("  2) get value from vault")
        print("  3) list available keys in the vault")
        option = int(input("option > "))

        match option:
            case 1:
                key = input("key  > ")
                text = input("text > ")
                assert all(i in printable for i in text)
                add(vault, user_keys, key, text)
                print(f"Successfully added the value ({vault[key]})")
            case 2:
                key = input("key > ")
                value = get(vault, user_keys, key)
                print(value)
            case 3:
                keys = [*vault]
                print(f"Available keys: {keys}")

        EVALUATION_PERIOD -= 1
        if EVALUATION_PERIOD <= 0:
            print("You used your entire allowance. Goodbye")
            exit(0)


if __name__ == "__main__":
    main()
```
